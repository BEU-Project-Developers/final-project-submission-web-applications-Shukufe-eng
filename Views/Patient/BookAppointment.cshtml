@model BookAppointmentViewModel
@{
    ViewData["Title"] = "Book Appointment";
}

<div class="row">
    <div class="col-lg-3">
        @await Html.PartialAsync("_PatientSidebar")
    </div>
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Book New Appointment</h5>
            </div>
            <div class="card-body">
                <form asp-action="BookAppointment" method="post">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="doctorId" class="form-label">Select Doctor</label>
                                <select asp-for="DoctorId" class="form-select" id="doctorId" required>
                                    <option value="">Choose a doctor...</option>
                                    @foreach (var doctor in Model.Doctors)
                                    {
                                        <option value="@doctor.Id" data-specialization="@doctor.Specialization">
                                            Dr. @doctor.Name - @doctor.Specialization
                                        </option>
                                    }                                </select>
                                <span asp-validation-for="DoctorId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="department" class="form-label">Department</label>
                                <select asp-for="Department" class="form-select" id="department" required>
                                    <option value="">Select Department</option>
                                    @foreach (var department in Model.Departments)
                                    {
                                        <option value="@department">@department</option>
                                    }
                                </select>
                                <span asp-validation-for="Department" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appointmentDate" class="form-label">Appointment Date</label>
                                <input asp-for="AppointmentDate" type="date" class="form-control" id="appointmentDate" 
                                       min="@DateTime.Now.ToString("yyyy-MM-dd")" required>
                                <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appointmentTime" class="form-label">Appointment Time</label>                                <select asp-for="AppointmentTime" class="form-select" id="appointmentTime" required>
                                    <option value="">Select time...</option>
                                    <!-- Time slots will be loaded dynamically based on doctor and date selection -->
                                </select>
                                <span asp-validation-for="AppointmentTime" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reasonForVisit" class="form-label">Reason for Visit</label>
                                <input asp-for="ReasonForVisit" type="text" class="form-control" id="reasonForVisit" 
                                       placeholder="e.g., Routine checkup, Follow-up..." required>
                                <span asp-validation-for="ReasonForVisit" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Additional Notes (Optional)</label>
                        <textarea asp-for="Notes" class="form-control" id="notes" rows="3" 
                                  placeholder="Any additional information or symptoms..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Please note:</strong> Your appointment will be scheduled and pending confirmation from the doctor's office. 
                                You will receive a confirmation email or call within 24 hours.
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="@Url.Action("Appointments", "Patient")" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Appointments
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-calendar-plus"></i> Book Appointment
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Available Time Slots Display -->
        <div class="card mt-4" id="timeSlotsCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">Available Time Slots</h6>
            </div>
            <div class="card-body">
                <div id="availableSlots">
                    <!-- Available slots will be loaded here via AJAX -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const doctorSelect = document.getElementById('doctorId');
        const dateInput = document.getElementById('appointmentDate');
        const timeSelect = document.getElementById('appointmentTime');
        
        function checkAvailability() {
            const doctorId = doctorSelect.value;
            const selectedDate = dateInput.value;
              if (doctorId && selectedDate) {
                fetch(`@Url.Action("GetAvailableSlots", "Patient")?doctorId=${doctorId}&date=${selectedDate}`)
                    .then(response => response.json())
                    .then(data => {
                        // Clear current options
                        timeSelect.innerHTML = '<option value="">Select time...</option>';
                        
                        // Add available slots
                        data.forEach(slot => {
                            const option = document.createElement('option');
                            option.value = slot.value;
                            option.textContent = slot.text;
                            if (!slot.available) {
                                option.disabled = true;
                                option.textContent += ' (Booked)';
                            }
                            timeSelect.appendChild(option);
                        });
                        
                        document.getElementById('timeSlotsCard').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error fetching availability:', error);
                    });
            }
        }
        
        doctorSelect.addEventListener('change', checkAvailability);
        dateInput.addEventListener('change', checkAvailability);
    });
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}